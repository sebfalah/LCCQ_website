<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8">
    <!-- Title Tag -->
    <title>Reservas | La Casa del Cangrejo – Reserva tu mesa en el Mejor Restaurante de Cangrejo y Mariscos en Quito</title>
    <!-- Meta Description -->
    <meta name="description" content="Reserva tu mesa en La Casa del Cangrejo y disfruta del mejor cangrejo y mariscos en Quito. Completa nuestro formulario y vive una experiencia gastronómica única.">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Reservas - La Casa del Cangrejo">
    
    <!-- UIkit CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/css/uikit.min.css">
    
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background-color: #fef9f4;
      }
      .reservation-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 20px;
      }
      .reservation-header .logo {
        display: flex;
        align-items: center;
        text-decoration: none;
      }
      .reservation-header .logo img {
        height: 60px;
      }
      .reservation-header .logo-subtitle {
        margin: 0 0 0 10px;
        font-weight: bold;
        color: #cc3300;
      }
      form {
        max-width: 400px;
        margin: 0 auto;
        padding: 16px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
      }
      label {
        display: block;
        margin: 12px 0 4px;
        font-weight: bold;
      }
      input, select {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-bottom: 8px;
      }
      button {
        padding: 10px 20px;
        background-color: #cc3300;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
      }
      button:hover {
        background-color: #e74c3c;
      }
      .footer {
        text-align: center;
        margin-top: 24px;
        color: #999;
      }

      /* ===== Estilos banner/modal de veda ===== */
      .closure-title {
        color: #cc0000; /* rojo */
        margin-bottom: 8px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .closure-logo {
        max-width: 140px;
        height: auto;
        margin: 6px auto 14px auto;
        display: block;
      }
      .closure-text {
        font-size: 1.25rem;   /* texto más grande */
        line-height: 1.7;     
      }
      .closure-text strong {
        font-size: 1.35rem;   /* ¡Hola! un poco más grande */
      }
      .note {
        font-size: 0.95rem; 
        color: #c00; 
        margin: 4px 0 0;
      }
    </style>
  </head>
  
<body>

  <!-- Encabezado con logo y botón de regreso al index -->
  <div class="reservation-header">
    <!-- Logo con enlace a la página principal -->
    <a class="logo navbar-brand" href="index.html" title="logo">
      <img src="images/logo.png" alt="logo">
      <p class="logo-subtitle">LA CASA DEL CANGREJO</p>
    </a>
    <!-- Botón para regresar -->
    <button class="uk-button uk-button-default" onclick="window.location.href='index.html'">
      Regresar
    </button>
  </div>

  <h1 style="text-align:center; color: #cc3300;">Haz tu Reserva</h1>

  <!-- The reservation form -->
  <form id="reservationForm">
    <label for="name">Nombre</label>
    <input type="text" id="name" name="name" required>

    <label for="email">Correo electrónico</label>
    <input type="email" id="email" name="email" required>

    <label for="phone">Teléfono</label>
    <input type="text" id="phone" name="phone" required
           placeholder="Ej: 0123456789 (10 dígitos)">

    <label for="date">Fecha de la reserva</label>
    <input type="date" id="date" name="date" required>
    <!-- Mensaje de fecha bloqueada -->
    <p id="dateMessage" class="uk-text-danger" style="margin:4px 0 0;"></p>
    <p id="dateNote" class="note" style="display:none;"></p>

    <!-- Nuevo campo: Hora -->
    <label for="time">Hora</label>
    <select id="time" name="time" required>
      <!-- Opciones se llenarán dinámicamente con JavaScript -->
    </select>

    <label for="guests">Número de personas</label>
    <input type="number" id="guests" name="guests" min="1" max="20" required>

    <button type="submit">Reservar</button>
  </form>

  <div class="footer">
    &copy; 2025 La Casa del Cangrejo
  </div>

  <!-- ===== Modal de cierre por veda (mismo banner) ===== -->
  <div id="closure-modal" uk-modal>
    <div class="uk-modal-dialog uk-modal-body uk-text-center">
      <button id="closure-close" class="uk-modal-close-default" type="button" aria-label="Cerrar" uk-close></button>
      <h3 class="closure-title">La Casa del Cangrejo</h3>
      <img class="closure-logo" src="images/logo.png" alt="Logo La Casa del Cangrejo">
      <p class="closure-text">
        <strong>¡Hola!</strong> Debido a la <em>veda de cangrejo</em> estaremos cerrados desde el <strong>21 de agosto</strong> hasta el <strong>15 de septiembre</strong>.<br>
        Atendemos con normalidad a partir del <strong>16 de septiembre</strong>.<br> ¡Te esperamos!
      </p>
    </div>
  </div>
  <!-- ===== Fin Modal de cierre ===== -->

  <!-- UIkit JS -->
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/js/uikit.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.2.6/dist/js/uikit-icons.min.js"></script>

  <script>
    // Replace with your actual deployed Google Apps Script Web App URL
    const googleScriptURL = "https://script.google.com/macros/s/AKfycbz710sC_2kYfPO2KjCVTspyarXCjsli_8Pv-JoXVYNTNw8O-pMgFxMOpi0Ge_3rJfDC/exec";

    // Fechas sin cupo (AAAA-MM-DD) adicionales puntuales
    const blockedDates = ["2025-05-01","2025-05-23","2025-08-15"];

    // ====== Ventana de cierre por veda ======
    const TZ = 'America/Guayaquil';
    const VEDA_START = '2025-08-21'; // inclusive
    const VEDA_END   = '2025-09-15'; // inclusive

    function getLocalDateStamp(tz) {
      const now = new Date();
      return new Intl.DateTimeFormat('en-CA', {
        timeZone: tz, year: 'numeric', month: '2-digit', day: '2-digit'
      }).format(now); // "YYYY-MM-DD"
    }

    function isWithinRange(isoDate, startIso, endIso) {
      return isoDate >= startIso && isoDate <= endIso;
    }

    // ====== Mostrar siempre el modal si estamos dentro del rango de veda ======
    (function showClosureBannerIfNeeded(){
      const today = getLocalDateStamp(TZ);
      if (isWithinRange(today, VEDA_START, VEDA_END)) {
        if (window.UIkit && UIkit.modal) {
          UIkit.modal('#closure-modal').show();
        }
      }
    })();

    // ====== Si hoy está dentro de la veda, guía al usuario a reservar desde 16/09 ======
    (function adjustDatePickerMinIfClosed(){
      const today = getLocalDateStamp(TZ);
      const dateInput = document.getElementById('date');
      const note = document.getElementById('dateNote');

      if (isWithinRange(today, VEDA_START, VEDA_END)) {
        dateInput.min = '2025-09-16';
        note.style.display = 'block';
        note.textContent = 'Las reservas estarán habilitadas a partir del 16 de septiembre.';
      }
    })();

    // Definimos los rangos de horas en intervalos de 30 minutos
    const timesWeekday = [
      "12:00", "12:30", "13:00", "13:30",
      "14:00", "14:30", "15:00", "15:30",
      "16:00", "16:30"
    ];
    const timesFriday = [
      "12:00", "12:30", "13:00", "13:30",
      "14:00", "14:30", "15:00", "15:30",
      "16:00", "16:30", "17:00", "17:30",
      "18:00", "18:30", "19:00", "19:30",
      "20:00"
    ];

    function populateTimeSlots(dayOfWeek) {
      const timeSelect = document.getElementById('time');
      timeSelect.innerHTML = "";
      // Jue(4) y Vie(5) con horario extendido; Mar(2), Mié(3) con horario corto
      const slots = (dayOfWeek === 4 || dayOfWeek === 5) ? timesFriday : timesWeekday;
      slots.forEach(time => {
        const option = document.createElement('option');
        option.value = time;
        option.textContent = time;
        timeSelect.appendChild(option);
      });
    }

    function clearTimeAndMessage() {
      document.getElementById('time').innerHTML = "";
      document.getElementById('dateMessage').textContent = "";
    }

    // Evento: cuando cambie la fecha
    document.getElementById('date').addEventListener('change', function() {
      const dateInput = this.value;
      const msgEl = document.getElementById('dateMessage');
      msgEl.textContent = ""; // limpia mensaje previo
      if (!dateInput) return;

      // 0) ¿Cae en la veda (bloqueo por rango)?
      if (isWithinRange(dateInput, VEDA_START, VEDA_END)) {
        msgEl.textContent = "No hay reservas disponibles entre el 21 de agosto y el 15 de septiembre por veda de cangrejo.";
        this.value = "";
        clearTimeAndMessage();
        return;
      }

      // 1) ¿Está bloqueada de forma puntual?
      if (blockedDates.includes(dateInput)) {
        msgEl.textContent = "Ya no hay reservas disponibles para la fecha seleccionada.";
        this.value = "";
        clearTimeAndMessage();
        return;
      }

      const [year, month, day] = dateInput.split('-').map(num => parseInt(num, 10));
      const reservationDate = new Date(Date.UTC(year, month - 1, day));
      const dayOfWeek = reservationDate.getUTCDay(); // 0=Dom,1=Lun,...6=Sab

      // Fin de semana
      if (dayOfWeek === 0 || dayOfWeek === 6) {
        alert("No se aceptan reservas en fin de semana");
        this.value = "";
        clearTimeAndMessage();
        return;
      }
      // Lunes
      if (dayOfWeek === 1) {
        alert("El restaurante está cerrado los lunes");
        this.value = "";
        clearTimeAndMessage();
        return;
      }

      // Si es martes(2), miércoles(3), jueves(4) o viernes(5), poblamos la lista de horas
      populateTimeSlots(dayOfWeek);
    });

    // Manejo del formulario en submit
    document.getElementById('reservationForm').addEventListener('submit', function(event) {
      event.preventDefault();

      // 1) Validar el teléfono
      const phoneValue = document.getElementById('phone').value.trim();
      const phonePattern = /^0\d{9}$/;
      if (!phonePattern.test(phoneValue)) {
        alert("El número de teléfono debe comenzar con 0 y tener 10 dígitos.");
        return;
      }

      // 2) Validar fecha
      const dateInput = document.getElementById('date').value;
      if (!dateInput) {
        alert("Por favor elige una fecha válida.");
        return;
      }

      // 2a) Bloqueo por veda (rango)
      if (isWithinRange(dateInput, VEDA_START, VEDA_END)) {
        alert("No hay reservas disponibles entre el 21 de agosto y el 15 de septiembre por veda de cangrejo.");
        return;
      }

      // 2b) ¿Bloqueada puntual?
      if (blockedDates.includes(dateInput)) {
        alert("Ya no hay reservas disponibles para la fecha seleccionada.");
        return;
      }

      const [year, month, day] = dateInput.split('-').map(num => parseInt(num, 10));
      const reservationDate = new Date(Date.UTC(year, month - 1, day));
      const dayOfWeek = reservationDate.getUTCDay();

      if (dayOfWeek === 0 || dayOfWeek === 6) {
        alert("No aceptamos reservas en fin de semana");
        return;
      }
      if (dayOfWeek === 1) {
        alert("El restaurante está cerrado los lunes");
        return;
      }

      // 3) Validar hora
      const timeValue = document.getElementById('time').value;
      if (!timeValue) {
        alert("Por favor selecciona una hora de llegada.");
        return;
      }

      // Todo OK, enviamos a Google Apps Script
      const form = document.getElementById('reservationForm');
      const formData = new FormData(form);

      fetch(googleScriptURL, {
        method: 'POST',
        body: formData
      })
      .then(response => response.text())
      .then(text => {
        alert(text);
        form.reset();
        document.getElementById('time').innerHTML = "";
        document.getElementById('dateMessage').textContent = "";
      })
      .catch(err => {
        console.error('Error:', err);
        alert('Error al guardar la reserva. Intenta nuevamente.');
      });
    });
  </script>
</body>
</html>
